<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è®¾å¤‡ç§Ÿé‡‘ç®¡ç†</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 24px;
      background: #f9fbfd;
      color: #333;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 32px;
      color: #2c3e50;
      font-weight: 600;
    }
    #productsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .product-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      overflow: hidden;
      transition: transform 0.2s;
    }
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .card-header {
      background: linear-gradient(135deg, #4A90E2, #5D8BF4);
      color: white;
      padding: 14px 16px;
      font-size: 18px;
      font-weight: 600;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .edit-product-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .edit-product-btn:hover {
      color: #ffd700;
    }
    .card-actions {
      display: flex;
      gap: 6px;
    }
    .card-actions button {
      padding: 4px 8px;
      font-size: 12px;
      margin: 0;
    }

    /* è§„æ ¼æ ‡ç­¾ï¼šè‡ªåŠ¨æ¢è¡Œ */
    .variant-tabs {
      display: flex;
      flex-wrap: wrap;
      padding: 8px 12px;
      background: #f8fafc;
      border-bottom: 1px solid #edf2f7;
      gap: 6px;
    }
    .variant-tab {
      padding: 6px 12px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
      color: #64748b;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 4px;
      border-radius: 4px;
    }
    .variant-tab.active {
      color: #4A90E2;
      background: #eef4ff;
      border-bottom-color: #4A90E2;
      font-weight: 600;
    }
    .variant-tab.add {
      color: #27ae60;
      font-weight: bold;
      margin-left: auto;
    }
    .edit-variant-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .edit-variant-btn:hover { color: #4A90E2; }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 16px;
    }
    .day-cell {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 4px;
      text-align: center;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .day-label {
      font-weight: 600;
      margin-bottom: 4px;
      color: #475569;
      font-size: 13px;
    }
    .manual-input {
      width: 60px;
      padding: 4px;
      font-size: 13px;
      text-align: center;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      outline: none;
    }
    .manual-input:focus {
      border-color: #4A90E2;
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }
    .auto-value {
      font-size: 12px;
      margin-top: 4px;
      min-height: 16px;
      font-weight: bold;
    }
    .auto-value.locked { color: #27ae60; }
    .auto-value.uncomputable { color: #e74c3c; }
    .auto-value:not(.locked):not(.uncomputable) { color: #e67e22; }

    button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      font-weight: 500;
    }
    button:hover { background: #45a049; }
    .delete-btn { background: #e74c3c; }
    .delete-btn:hover { background: #c0392b; }

    .floating-buttons {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    .floating-buttons button {
      width: 120px;
      padding: 8px;
      font-size: 14px;
    }

    #loadStatus {
      text-align: center;
      color: #e74c3c;
      font-weight: bold;
      margin-bottom: 16px;
    }

    @media (max-width: 850px) {
      #productsContainer {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<h1>è®¾å¤‡ç§Ÿé‡‘ç®¡ç†</h1>
<div id="loadStatus"></div>
<div id="productsContainer"></div>

<div class="floating-buttons">
  <button onclick="addNewProduct()">â• æ·»åŠ æ–°å“å</button>
  <button onclick="exportData()">ğŸ“¤ å¯¼å‡º data.json</button>
  <button onclick="copyJsonData()">ğŸ“‹ å¤åˆ¶ JSON æ•°æ®</button>
</div>

<script>
let allData = {};

document.addEventListener('DOMContentLoaded', async () => {
  await loadData();
  renderAllProducts();
});

async function loadData() {
  const statusEl = document.getElementById('loadStatus');
  try {
    const res = await fetch('data.json');
    if (res.ok) {
      allData = await res.json();
      statusEl.textContent = 'âœ… å·²åŠ è½½ data.json';
      statusEl.style.color = '#27ae60';
    } else {
      allData = {};
      statusEl.innerHTML = 'âš ï¸ æœªæ‰¾åˆ° <code>data.json</code>ï¼Œä½¿ç”¨ç©ºæ•°æ®<br>è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”é€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®';
    }
  } catch (err) {
    console.error('åŠ è½½ data.json å¤±è´¥:', err);
    allData = {};
    statusEl.innerHTML = 'âŒ åŠ è½½ <code>data.json</code> å¤±è´¥ï¼<br>åŸå› ï¼š' + err.message + '<br>è¯·é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ï¼ˆå¦‚ Live Serverï¼‰è®¿é—®';
  }
}

function validateRent(product, variant, day, value) {
  const currentValues = allData[product]?.[variant] || {};
  const entries = Object.entries(currentValues).map(([d, v]) => ({
    day: parseInt(d),
    rent: parseFloat(v)
  })).filter(e => !isNaN(e.rent));

  entries.push({ day: parseInt(day), rent: parseFloat(value) });
  entries.sort((a, b) => a.day - b.day);

  for (let i = 1; i < entries.length; i++) {
    if (entries[i].rent < entries[i - 1].rent) {
      return {
        valid: false,
        message: `é”™è¯¯ï¼š${entries[i].day}å¤©ç§Ÿé‡‘ï¼ˆÂ¥${entries[i].rent}ï¼‰ä½äº${entries[i-1].day}å¤©ï¼ˆÂ¥${entries[i-1].rent}ï¼‰ï¼ç§Ÿé‡‘åº”éšå¤©æ•°å¢åŠ æˆ–æŒå¹³ã€‚`
      };
    }
  }
  return { valid: true };
}

function renderAllProducts() {
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';

  for (const productName in allData) {
    const card = createProductCard(productName, allData[productName]);
    container.appendChild(card);
  }
}

function createProductCard(productName, variants) {
  const card = document.createElement('div');
  card.className = 'product-card';
  card.dataset.product = productName;

  const header = document.createElement('div');
  header.className = 'card-header';
  header.innerHTML = `
    <div class="card-title">
      ${productName}
      <button class="edit-product-btn" onclick="editProductName(event, '${productName}')">âœï¸</button>
    </div>
    <div class="card-actions">
      <button class="delete-btn" onclick="deleteProduct('${productName}')">ğŸ—‘ï¸ åˆ é™¤</button>
    </div>
  `;
  card.appendChild(header);

  const tabs = document.createElement('div');
  tabs.className = 'variant-tabs';
  const variantNames = Object.keys(variants);
  variantNames.forEach(vName => {
    const tab = document.createElement('div');
    tab.className = 'variant-tab';
    tab.innerHTML = `
      ${vName}
      <button class="edit-variant-btn" onclick="editVariantName(event, '${productName}', '${vName}')">âœï¸</button>
    `;
    tab.dataset.variant = vName;
    tab.onclick = (e) => {
      if (e.target.classList.contains('edit-variant-btn')) return;
      tabs.querySelectorAll('.variant-tab').forEach(t => t.classList.remove('active'));
      e.currentTarget.classList.add('active');
      switchVariant(productName, vName);
    };
    tabs.appendChild(tab);
  });
  if (variantNames.length > 0) {
    tabs.firstChild.classList.add('active');
  }

  const addTab = document.createElement('div');
  addTab.className = 'variant-tab add';
  addTab.textContent = '+';
  addTab.onclick = () => addNewVariant(productName);
  tabs.appendChild(addTab);
  card.appendChild(tabs);

  const calendar = document.createElement('div');
  calendar.className = 'calendar-grid';
  calendar.dataset.product = productName;
  calendar.dataset.variant = variantNames[0] || '';
  if (variantNames[0]) {
    renderCalendar(productName, variantNames[0], calendar);
  }
  card.appendChild(calendar);

  return card;
}

function switchVariant(productName, variantName) {
  const calendar = document.querySelector(`.calendar-grid[data-product="${productName}"]`);
  if (calendar) {
    calendar.dataset.variant = variantName;
    renderCalendar(productName, variantName, calendar);
  }
}

function renderCalendar(productName, variantName, container) {
  container.innerHTML = '';
  const manualValues = allData[productName]?.[variantName] || {};

  const lockedPoints = [];
  for (let d = 1; d <= 30; d++) {
    if (manualValues.hasOwnProperty(d)) {
      lockedPoints.push({ day: d, value: parseFloat(manualValues[d]) });
    }
  }
  lockedPoints.sort((a, b) => a.day - b.day);

  const autoValues = {};
  if (lockedPoints.length === 0) {
    for (let d = 1; d <= 30; d++) autoValues[d] = null;
  } else if (lockedPoints.length === 1) {
    const p = lockedPoints[0];
    autoValues[p.day] = p.value;
    for (let d = 1; d <= 30; d++) {
      if (d !== p.day) autoValues[d] = null;
    }
  } else {
    const first = lockedPoints[0];
    for (let d = 1; d < first.day; d++) autoValues[d] = null;
    autoValues[first.day] = first.value;

    for (let i = 0; i < lockedPoints.length - 1; i++) {
      const start = lockedPoints[i];
      const end = lockedPoints[i + 1];
      const slope = (end.value - start.value) / (end.day - start.day);
      for (let d = start.day + 1; d < end.day; d++) {
        autoValues[d] = start.value + (d - start.day) * slope;
      }
      autoValues[end.day] = end.value;
    }

    const last = lockedPoints[lockedPoints.length - 1];
    for (let d = last.day + 1; d <= 30; d++) autoValues[d] = null;
  }

  for (let day = 1; day <= 30; day++) {
    const cell = document.createElement('div');
    cell.className = 'day-cell';

    const label = document.createElement('div');
    label.className = 'day-label';
    label.textContent = `${day}å¤©`;

    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.01';
    input.className = 'manual-input';
    input.dataset.product = productName;
    input.dataset.variant = variantName;
    input.dataset.day = day;
    if (manualValues.hasOwnProperty(day)) {
      input.value = manualValues[day];
    }
    input.addEventListener('blur', (e) => handleBlur(e.target));

    const autoDiv = document.createElement('div');
    autoDiv.className = 'auto-value';
    const autoVal = autoValues[day];
    if (manualValues.hasOwnProperty(day)) {
      autoDiv.textContent = `Â¥${parseFloat(manualValues[day]).toFixed(2)}`;
      autoDiv.classList.add('locked');
    } else if (autoVal !== null && !isNaN(autoVal)) {
      autoDiv.textContent = `Â¥${autoVal.toFixed(2)}`;
    } else {
      autoDiv.textContent = 'â€”';
      autoDiv.classList.add('uncomputable');
    }

    cell.appendChild(label);
    cell.appendChild(input);
    cell.appendChild(autoDiv);
    container.appendChild(cell);
  }
}

function handleBlur(inputEl) {
  const product = inputEl.dataset.product;
  const variant = inputEl.dataset.variant;
  const day = parseInt(inputEl.dataset.day);
  const value = inputEl.value.trim();

  if (!allData[product]) allData[product] = {};
  if (!allData[product][variant]) allData[product][variant] = {};

  if (value === '') {
    delete allData[product][variant][day];
    const calendar = document.querySelector(`.calendar-grid[data-product="${product}"]`);
    if (calendar) renderCalendar(product, variant, calendar);
    return;
  }

  const num = parseFloat(value);
  if (isNaN(num)) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—ï¼');
    inputEl.value = '';
    delete allData[product][variant][day];
    return;
  }

  const validationResult = validateRent(product, variant, day, num);
  if (!validationResult.valid) {
    alert(validationResult.message);
    inputEl.value = '';
    delete allData[product][variant][day];
    const calendar = document.querySelector(`.calendar-grid[data-product="${product}"]`);
    if (calendar) renderCalendar(product, variant, calendar);
    return;
  }

  allData[product][variant][day] = num;

  const calendar = document.querySelector(`.calendar-grid[data-product="${product}"]`);
  if (calendar) {
    renderCalendar(product, variant, calendar);
  }
}

// ========== æ–°å¢ï¼šç¼–è¾‘å“å ==========
function editProductName(event, oldName) {
  event.stopPropagation();
  const newName = prompt('ä¿®æ”¹å“å', oldName);
  if (!newName || !newName.trim() || newName.trim() === oldName) return;
  const cleanName = newName.trim();
  if (allData[cleanName]) {
    alert('è¯¥å“åå·²å­˜åœ¨ï¼');
    return;
  }

  // é‡å»º allDataï¼ˆä¿æŒé¡ºåºï¼‰
  const newData = {};
  for (const key in allData) {
    if (key === oldName) {
      newData[cleanName] = allData[key];
    } else {
      newData[key] = allData[key];
    }
  }
  allData = newData;
  renderAllProducts();
}

function editVariantName(event, productName, oldName) {
  event.stopPropagation();
  const newName = prompt('ä¿®æ”¹è§„æ ¼åç§°', oldName);
  if (!newName || !newName.trim() || newName.trim() === oldName) return;
  const cleanName = newName.trim();
  if (allData[productName][cleanName]) {
    alert('è¯¥è§„æ ¼åç§°å·²å­˜åœ¨ï¼');
    return;
  }

  const newVariants = {};
  for (const key in allData[productName]) {
    if (key === oldName) {
      newVariants[cleanName] = allData[productName][key];
    } else {
      newVariants[key] = allData[productName][key];
    }
  }
  allData[productName] = newVariants;
  renderAllProducts();
}

function addNewProduct() {
  const name = prompt('è¾“å…¥æ–°å“åï¼ˆå¦‚ Quest 3 Proï¼‰');
  if (!name || !name.trim()) return;
  const clean = name.trim();
  if (allData[clean]) {
    alert('è¯¥å“åå·²å­˜åœ¨ï¼');
    return;
  }
  allData[clean] = {};
  renderAllProducts();
}

function addNewVariant(productName) {
  const name = prompt('è¾“å…¥æ–°è§„æ ¼ï¼ˆå¦‚ 512Gï¼‰');
  if (!name || !name.trim()) return;
  const clean = name.trim();
  if (allData[productName][clean]) {
    alert('è¯¥è§„æ ¼å·²å­˜åœ¨ï¼');
    return;
  }
  allData[productName][clean] = {};
  renderAllProducts();
}

function deleteProduct(productName) {
  if (!confirm(`ç¡®å®šåˆ é™¤ã€Œ${productName}ã€åŠå…¶æ‰€æœ‰è§„æ ¼ï¼Ÿ`)) return;
  delete allData[productName];
  renderAllProducts();
}

function exportData() {
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function copyJsonData() {
  try {
    const jsonStr = JSON.stringify(allData, null, 2);
    await navigator.clipboard.writeText(jsonStr);
    alert('âœ… JSON æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥:', err);
    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ã€‚');
  }
}
</script>

</body>
</html>
